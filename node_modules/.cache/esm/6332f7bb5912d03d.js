let joi,CustomErrorHandler,RefreshToken,User,bcrypt,JwtService,REFRESH_SECRET,refreshToken;_591‍.x([["default",()=>_591‍.o]]);_591‍.w("joi",[["default",["joi"],function(v){joi=v}]]);_591‍.w("../../services/CustomErrorHandler",[["default",["CustomErrorHandler"],function(v){CustomErrorHandler=v}]]);_591‍.w("../../models",[["RefreshToken",["RefreshToken"],function(v){RefreshToken=v}],["User",["User"],function(v){User=v}]]);_591‍.w("bcrypt",[["default",["bcrypt"],function(v){bcrypt=v}]]);_591‍.w("../../services/JwtService",[["default",["JwtService"],function(v){JwtService=v}]]);_591‍.w("../../config",[["REFRESH_SECRET",["REFRESH_SECRET"],function(v){REFRESH_SECRET=v}]]);_591‍.w("../../models/refreshToken",[["default",["refreshToken"],function(v){refreshToken=v}]]);







const registerController={

   async regirster(req,resp,next){
      //validation Schema
      const registerSchema= joi.object({
        name: joi.string().min(3).max(30).required(),
        email: joi.string().email().required(),
        password: joi.string().pattern(new RegExp('^[a-zA-Z0-9]{3,30}$')).required(),
        rPassword: joi.ref('password'),  
    })

       _591‍.g.console.log(req.body)
     const {error}= registerSchema.validate(req.body)
       
           if(error){
            return next(error);
           }

      try{
           const exist= await  User.exists({email: req.body.email})
           if(exist){
                return next(CustomErrorHandler.alreadyExist('This email is already Exist'))
           }
      } catch(err){
           return next(err);
      }

      // Hash Password
      const hashedPassword = await bcrypt.hash(req.body.password, 10);

      // Prepare the model
      const {name, email, password} = req.body;
      const user= new User({
          name,
          email,
          password: hashedPassword
      })


      let access_token;
      let refresh_token;
        try{

           const result = await user.save();
         
          _591‍.g.console.log(result)
           //Token
      access_token=JwtService.sign({_id: result._id, role: result.role, name: result.name})
      refresh_token=JwtService.sign({_id: result._id, role: result.role, name: result.name},'1y',REFRESH_SECRET)
       
      //DatabaseWhitlist        
       await RefreshToken.create({token: refresh_token})
     } catch(err){
           return next(err);
        }




        resp.json({ access_token, refresh_token})
    }
}

_591‍.d(registerController);










